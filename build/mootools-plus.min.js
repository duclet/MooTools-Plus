MooTools.Plus={version:"0.1"};Class.extend({bindInstances:function(a){var b,c;for(c in a){b=a[c];if(typeOf(b)==="function"&&c!=="$caller")a[c]=b.bind(a)}return a}});Class.Mutators.Static=function(a){Array.from(a).each(this.extend,this)};
Class.Mutators.StoredInstances=function(){this.extend({$instances:{},retrieveInstance:function(a){return[this.$instances[a]].pick()}}).implement({retrieveInstance:function(a){return this.$caller.$owner.retrieveInstance(a)},storeInstance:function(a){var b=this.retrieveInstance(a);if(b)return b;this.$caller.$owner.$instances[a]=this;return true}})};
Function.implement({curry:function(a,b){var c=this,d=Array.from(a);return function(){var e=d.concat(Array.from(arguments));return c.apply([b,this].pick(),e)}}});
var HtmlOptionsJS=new Class({Implements:[Events,Options],options:{options_selector:".htmloptions"},loadAllOptions:function(a,b){this.loadOptions(a);this.setOptions(b);return this},loadExtraOptions:function(){return false},loadOptions:function(a){a=a.getElement(this.options.options_selector);if(!a)return this;a.hide();a.getChildren().each(this.setOption.curry(this.options,this));return this},setOption:function(a,b){var c=b.get("class"),d=b.get("title"),e=b.get(c==="html"?"html":"text");if(this.loadExtraOptions(a,
b,c,d))return this;switch(c){case "boolean":a[d]=e!=="false";break;case "double":a[d]=e.toFloat();break;case "eval":a[d]=eval(e);break;case "event":this.addEvent(d,eval(e));break;case "integer":a[d]=e.toInt();break;case "html":case "string":a[d]=e}return this}});
Element.implement({getTrueHeight:function(){var a=this.getStyle("overflow");this.setStyle("overflow","hidden");var b=this.getHeight()-this.getStyle("padding-top").toInt()-this.getStyle("padding-bottom").toInt()-this.getStyle("border-top-width").toInt()-this.getStyle("border-bottom-width").toInt();this.setStyle("overflow",a);return b},getTrueWidth:function(){var a=this.getStyle("overflow");this.setStyle("overflow","hidden");var b=this.getWidth()-this.getStyle("padding-left").toInt()-this.getStyle("padding-right").toInt()-
this.getStyle("border-left-width").toInt()-this.getStyle("border-right-width").toInt();this.setStyle("overflow",a);return b},replacesWith:function(a){a=Elements.from(a);var b=a.shift();b.replaces(this);a.reverse().invoke("inject",b,"after");return this},update:function(a){a=a.toString?a.toString():""+a;this.set("html",a);a.stripScripts(true);return this}});
(function(){var a=1;Element.Properties.id={get:function(){var b=this.id;if(b.length<1){do b="anonymous_id_"+a++;while(document.id(b));this.set("id",b)}return b}}})();(function(){Element.implement({delegateEvent:function(a,b,c){a=a.toLowerCase();if(!Browser.ie)switch(a){case "focusin":a="focus";break;case "focusout":a="blur"}return this.addEvent(a+":relay("+b+")",c)}})})();
var NamedChainJS=new Class({$fns:[],$keys:[],initialize:function(){Class.bindInstances(this);return this},append:function(a,b){return this.insertAt(this.$fns.length,a,b)},clear:function(){this.$fns=[];this.$keys=[];return this},insertAfter:function(a,b,c){a=this.$keys.indexOf(a);if(a===-1)a=this.$keys.length;else++a;return this.insertAt(a,b,c)},insertBefore:function(a,b,c){a=this.$keys.indexOf(a);if(a===-1)a=0;return this.insertAt(a,b,c)},insertAt:function(a,b,c){this.$keys.splice(a,0,b);this.$fns.splice(a,
0,c);return this},prepend:function(a,b){return this.insertAt(0,a,b)},remove:function(a){a=this.$keys.indexOf(a);if(a!==-1){this.$keys.splice(a,1);this.$fns.splice(a,1)}return this},run:function(){if(this.$fns.length>0){this.$keys.shift();this.$fns.shift().call(this)}return this}}),ResponsesJS=new Class({Extends:Request.JSON,options:{change_cursor:false,extra_data:null},initialize:function(a){Class.bindInstances(this);this.parent(a);this.options.link=a&&a.link?a.link:"cancel";this.addEvent("success",
this.handleResponse,true);return this},alertResponse:function(a){window.alert(a.message);return this},callbackResponse:function(a){this.fireEvent(this.getHandlerName(a.key),Array.from(a.parameters));return this},elementReplaceResponse:function(a){document.id(a.element_id).replacesWith(a.html);a.html.stripScripts(true);return this},elementUpdateResponse:function(a){document.id(a.element_id).update(a.html);return this},functionCallResponse:function(a){var b=eval(a.fn),c=eval(a.scope);b.apply(c,Array.from(a.parameters));
return this},redirectResponse:function(){var a=new Element("form",{action:item.url,method:"post"});a.inject(document.body);a.submit();return this},reloadResponse:function(){window.location.reload();return this},addHandler:function(a,b){this.addEvent(this.getHandlerName(a),b);return this},continueChain:function(){this.options.extra_data&&instanceOf(this.options.extra_data.chain,NamedChainJS)&&this.options.extra_data.chain.run();return this},getHandlerName:function(a){return"responsesjs_custom_handler_"+
a},handleResponse:function(a){this.options.change_cursor&&document.body&&document.body.setStyle("cursor","auto");if(!a){this.options.extra_data=null;this.failure();return this}this.fireEvent("startProcessing",[this,a]);a.each(function(b){switch(b.type){case "alert":this.alertResponse(b);break;case "callback":this.callbackResponse(b);break;case "element_replace":this.elementReplaceResponse(b);break;case "element_update":this.elementUpdateResponse(b);break;case "function_call":this.functionCallResponse(b);
break;case "redirect":this.redirectResponse(b);break;case "reload":this.reloadResponse(b)}this.fireEvent("processItem",[this,b])},this);this.fireEvent("finishProcessing",[this,a]);this.options.extra_data=null;return this},send:function(a){if(a&&a.extra_data)this.options.extra_data=a.extra_data;this.options.change_cursor&&document.body&&document.body.setStyle("cursor","progress");return this.parent(a)}}),AutoCompleteJS=new Class({Implements:[Events,Options],StoredInstances:true,Static:{Chain:{hide:{fire_event:"AutoCompleteJS.hide:fire_event",
render:"AutoCompleteJS.hide:render"},show:{fire_event:"AutoCompleteJS.show:fire_event",request:"AutoCompleteJS.show:request",render:"AutoCompleteJS.show:render"},useSelected:{fire_event:"AutoCompleteJS.useSelected:fire_event",render:"AutoCompleteJS.useSelected:render"}},Constants:{INDEX:"AutoCompleteJS.Constants.INDEX",PREVIOUS:"AutoCompleteJS.Constants.PREVIOUS"},singleton:function(a,b,c){var d=this.retrieveInstance(a);if(!d){d=new AutoCompleteJS(b,c);d.storeInstance(a)}return d}},options:{min_length:3,
query:"query",extra_data:{}},$responses:null,$suggestions:[],$visible:false,server:null,element:null,elements:null,input:null,initialize:function(a,b){Class.bindInstances(this);this.setOptions(b);this.server=a;this.$responses=new ResponsesJS;this.$responses.addEvent("processItem",this.handleResponse).addEvent("finishProcessing",this.$responses.continueChain);return this.build().attachInternal()},onBlur:function(){return this.hide()},onClick:function(a,b){a.preventDefault();return this.setSelection(b.retrieve(AutoCompleteJS.Constants.INDEX))},
onFocus:function(a,b){b.set("autocomplete","false");return this},onKeyDown:function(a){if(a.key==="enter"||a.key==="esc")a.preventDefault();else a.key==="tab"&&this.useSelected();return this},onKeyUp:function(a,b){this.input=b;switch(a.key){case "enter":this.useSelected();break;case "esc":this.hide();break;case "down":case "up":var c=this.elements.suggestions.getElement(".suggestion.selected").retrieve(AutoCompleteJS.Constants.INDEX);if(c>0&&a.key==="up")--c;else c<this.$suggestions.length-1&&a.key===
"down"&&++c;this.setSelection(c);break;case "left":case "right":break;default:this.input.get("value").length>=this.options.min_length?this.show():this.hide()}return this},onMouseOver:function(a,b){return this.setSelection(b.retrieve(AutoCompleteJS.Constants.INDEX))},attach:function(a){document.id(document.body).delegateEvent("focus",a,this.onFocus).delegateEvent("blur",a,this.onBlur).delegateEvent("keydown",a,this.onKeyDown).delegateEvent("keyup",a,this.onKeyUp);return this},attachInternal:function(){this.element.delegateEvent("click",
".suggestion",this.onClick).delegateEvent("mouseover",".suggestion",this.onMouseOver);return this},build:function(){this.elements={loading:new Element("div.loading"),suggestions:new Element("div.suggestions")};this.element=(new Element("div.autocompletejs")).adopt(this.elements.loading,this.elements.suggestions).hide().inject(document.body);return this},getDisplayText:function(a){return a.replace(RegExp("("+this.input.get("value")+")","gi"),'<span class="provided">$1</span>')},handleResponse:function(a,
b){switch(b.type){case "AutoCompleteJS:update_suggestions":this.$suggestions=b.data}return this},hide:function(){var a=new NamedChainJS;a.append(AutoCompleteJS.Chain.hide.fire_event,this.__hideFireEvent.curry(a)).append(AutoCompleteJS.Chain.hide.render,this.__hideRender.curry(a)).run();return this},__hideFireEvent:function(a){this.fireEvent("hide",[this,a]);a.run()},__hideRender:function(a){this.$visible=false;this.element.hide();a.run()},renderSuggestions:function(){if(!this.$suggestions.length)return this.hide();
this.elements.suggestions.set("html","");this.$suggestions.each(function(a,b){(new Element("div.suggestion")).store(AutoCompleteJS.Constants.INDEX,b).update(this.getDisplayText(a.display)).inject(this.elements.suggestions)},this);this.elements.suggestions.getElement(".suggestion").addClass("selected");return this},setSelection:function(a){for(var b=this.elements.suggestions.getElements(".suggestion"),c=0,d=b.length;c<d;++c)c===a?b[c].addClass("selected"):b[c].removeClass("selected");this.elements.suggestions.getElement(".suggestion.selected")||
this.elements.suggestions.getElement(".suggestion").addClass("selected");return this},show:function(){if(!this.$visible||this.input.get("value")!==this.input.retrieve(AutoCompleteJS.Constants.PREVIOUS)){var a=new NamedChainJS;a.append(AutoCompleteJS.Chain.show.fire_event,this.__showFireEvent.curry(a)).append(AutoCompleteJS.Chain.show.request,this.__showRequest.curry(a)).append(AutoCompleteJS.Chain.show.render,this.__showRender.curry(a)).run()}return this},__showFireEvent:function(a){this.fireEvent("preShow",
[this,a]);this.elements.loading.show();this.elements.suggestions.hide();this.element.show();this.element.position({relativeTo:this.input,edge:"upperLeft",position:"bottomLeft"});a.run()},__showRequest:function(a){if(typeOf(this.server)==="function"){this.$suggestions=this.server(this);a.run()}else{var b=Object.append({},this.options.extra_data);b[this.options.query]=this.input.get("value");this.$responses.send({method:"get",url:this.server,extra_data:{chain:a},data:b})}},__showRender:function(a){this.input.store(AutoCompleteJS.Constants.PREVIOUS,
this.input.get("value"));this.renderSuggestions();this.elements.loading.hide();this.elements.suggestions.show();this.$visible=true;this.fireEvent("postShow",[this,a]);a.run()},useSelected:function(){var a=new NamedChainJS,b=document.id(this.input.get("data-hidden-field")),c=this.elements.suggestions.getElement(".suggestion.selected").retrieve(AutoCompleteJS.Constants.INDEX);a.append(AutoCompleteJS.Chain.useSelected.fire_event,this.__useSelectedFireEvent.curry([a,this.$suggestions[c],b])).append(AutoCompleteJS.Chain.useSelected.render,
this.__useSelectedRender.curry([a,this.$suggestions[c],b])).run();return this},__useSelectedFireEvent:function(a,b,c){this.fireEvent("selection",[this,a,b,c]);a.run()},__useSelectedRender:function(a,b,c){if(c){c.set("value",b.value);this.input.set("value",b.display)}else this.input.set("value",b.value);this.hide();a.run()}}),LayerJS=new Class({Implements:[HtmlOptionsJS],StoredInstances:true,Static:{Chain:{fetchUrl:{fire_event:"LayerJS.fetchUrl:fire_event",request:"LayerJS.fetchUrl:request",wrapup:"LayerJS.fetchUrl:wrapup"},
hide:{fire_event:"LayerJS.hide:fire_event",hide:"LayerJS.hide:hide"},show:{fire_event:"LayerJS.show:fire_event",request:"LayerJS.show:request",show:"LayerJS.show:show"},submitForm:{fire_event:"LayerJS.submitForm:fire_event",request:"LayerJS.submitForm:request",wrapup:"LayerJS.submitForm:wrapup"}},singleton:function(a,b){var c=this.retrieveInstance(a);if(!c){c=new LayerJS(b);c.storeInstance(a)}return c}},options:{element:null,layer_classname:"layerjs",intercept_classname:"layer-intercept",refetch:false,
template:null,url:null,content_selector:".layer-content",hide_selector:".hide-layer"},element:null,$responses:null,initialize:function(a){Class.bindInstances(this);if(!a||!a.element)this.build(a);else this.element=document.id(a.element);this.$responses=new ResponsesJS;this.$responses.addEvent("processItem",this.handleResponse).addEvent("finishProcessing",this.$responses.continueChain);this.loadAllOptions(this.element,a);this.element.addClass(this.options.layer_classname).get("id");return this.attach()},
onClick:function(a,b){if(b.match(this.options.hide_selector)||b.getParent(this.options.hide_selector))return this;if(b.hasClass(this.options.intercept_classname)){a.preventDefault();this.fetchUrl(b.getProperty("href"))}return this},onHide:function(a){a.preventDefault();return this.hide()},onSubmit:function(a,b){if(b.hasClass(this.options.intercept_classname)){a.preventDefault();this.submitForm(b)}return this},attach:function(){this.element.delegateEvent("click",this.options.hide_selector,this.onHide);
this.element.delegateEvent("click","a",this.onClick);this.element.delegateEvent("submit","form",this.onSubmit)},build:function(a){this.element=a&&a.template?Elements.from(a.template).getFirst():new Element("div");this.element.inject(document.body).hide();return this},fetchUrl:function(a,b){var c=new NamedChainJS;c.append(LayerJS.Chain.fetchUrl.fire_event,this.__fetchUrlFireEvent.curry(c)).append(LayerJS.Chain.fetchUrl.request,this.__fetchUrlRequest.curry([c,a])).append(LayerJS.Chain.fetchUrl.wrapup,
this.__fetchUrlWrapup.curry([c,b])).run();return this},__fetchUrlFireEvent:function(a){this.fireEvent("startFetching",[this,a]);a.run()},__fetchUrlRequest:function(a,b){this.$responses.send({method:"get",url:b,extra_data:{chain:a}})},__fetchUrlWrapup:function(a,b){this.fireEvent("finishFetching",[this,a]);instanceOf(b,NamedChainJS)&&b.run();a.run()},handleResponse:function(a,b){switch(b.type){case "LayerJS:update":this.updateContent(b.html)}return this},hide:function(){var a=new NamedChainJS;a.append(LayerJS.Chain.hide.fire_event,
this.__hideFireEvent.curry(a)).append(LayerJS.Chain.hide.hide,this.__hideHide.curry(a)).run();return this},__hideFireEvent:function(a){this.fireEvent("hide",[this,a]);a.run()},__hideHide:function(a){this.element.hide();a.run()},show:function(){var a=new NamedChainJS;a.append(LayerJS.Chain.show.fire_event,this.__showFireEvent.curry(a)).append(LayerJS.Chain.show.request,this.__showRequest.curry(a)).append(LayerJS.Chain.show.show,this.__showShow.curry(a)).run();return this},__showFireEvent:function(a){this.fireEvent("show",
[this,a]);a.run()},__showRequest:function(a){this.options.url?this.fetchUrl(this.options.url,a):a.run()},__showShow:function(a){if(this.options.url&&!this.options.refetch)this.options.url=null;this.element.show();a.run()},submitForm:function(a){var b=new NamedChainJS;b.append(LayerJS.Chain.submitForm.fireEvent,this.__submitFormFireEvent.curry(b)).append(LayerJS.Chain.submitForm.request,this.__submitFormRequest.curry([b,a])).append(LayerJS.Chain.submitForm.wrapup,this.__submitFormWrapup.curry(b)).run();
return this},__submitFormFireEvent:function(a){this.fireEvent("startPosting",[this,a]);a.run()},__submitFormRequest:function(a,b){this.$responses.send({method:b.get("method"),url:b.get("action"),data:b.toQueryString(),extra_data:{chain:a}})},__submitFormWrapup:function(a){this.fireEvent("finishPosting",[this,a]);a.run()},updateContent:function(a){var b=this.element.getElement(this.options.content_selector);b&&b.update(a);return this}});Array.implement({getFirst:function(){if(this.length>0)return this[0]}});
String.implement({toConfigurationData:function(){var a={};this.split(" ").each(function(b){if(b.contains(":")){var c=b.split(":");b=c.shift();c=c.join(":");this[b]=c}},a);return a}});
Class.refactor(Cookie,{options:{type:"days"},write:function(a){var b=this.options.duration;if(b===false)this.options.duration=0;if(this.options.duration!==0)switch(this.options.type){case "years":this.options.duration*=365;break;case "seconds":this.options.duration/=60;case "minutes":this.options.duration/=60;case "hours":this.options.duration/=24}this.previous(a);this.options.duration=b;return this}});
